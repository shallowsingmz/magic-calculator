<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>魔术计算器</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #ffffff;
            overflow: hidden;
        }

        .calculator {
            width: 100%;
            max-width: 400px;
            height: 100%;
            max-height: 850px;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .display-container {
            flex: 1;
            display: flex;
            justify-content: flex-end;
            align-items: flex-end;
            padding: 20px 10px;
        }

        .display {
            font-size: 80px;
            font-weight: 300;
            text-align: right;
            word-wrap: break-word;
            word-break: break-all;
            line-height: 1;
        }

        /* 彩蛋绿色字体 */
        .display.success {
            color: #34C759;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding-bottom: 30px;
        }

        .btn {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 50%;
            border: none;
            font-size: 32px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: filter 0.2s;
        }

        .btn:active {
            filter: brightness(1.5);
        }

        /* 颜色分类 */
        .btn-gray {
            background-color: #A5A5A5;
            color: #000000;
        }
        
        .btn-dark {
            background-color: #333333;
            color: #ffffff;
        }

        .btn-orange {
            background-color: #FF9F0A;
            color: #ffffff;
            font-size: 40px;
        }

        .btn-zero {
            grid-column: span 2;
            aspect-ratio: auto;
            border-radius: 40px;
            justify-content: flex-start;
            padding-left: 30px;
        }
    </style>
</head>
<body>

<div class="calculator">
    <div class="display-container">
        <div class="display" id="display">0</div>
    </div>
    <div class="buttons">
        <button class="btn btn-gray btn-ac" id="btn-ac">AC</button>
        <button class="btn btn-gray" data-action="toggle-sign">+/-</button>
        <button class="btn btn-gray" data-action="percent">%</button>
        <button class="btn btn-orange" data-action="operator" data-val="÷">÷</button>

        <button class="btn btn-dark" data-action="number" data-val="7">7</button>
        <button class="btn btn-dark" data-action="number" data-val="8">8</button>
        <button class="btn btn-dark" data-action="number" data-val="9">9</button>
        <button class="btn btn-orange" data-action="operator" data-val="×">×</button>

        <button class="btn btn-dark" data-action="number" data-val="4">4</button>
        <button class="btn btn-dark" data-action="number" data-val="5">5</button>
        <button class="btn btn-dark" data-action="number" data-val="6">6</button>
        <button class="btn btn-orange" data-action="operator" data-val="-">-</button>

        <button class="btn btn-dark" data-action="number" data-val="1">1</button>
        <button class="btn btn-dark" data-action="number" data-val="2">2</button>
        <button class="btn btn-dark" data-action="number" data-val="3">3</button>
        <button class="btn btn-orange" data-action="operator" data-val="+">+</button>

        <button class="btn btn-dark btn-zero" data-action="number" data-val="0">0</button>
        <button class="btn btn-dark" data-action="number" data-val=".">.</button>
        <button class="btn btn-orange" id="btn-eq" data-action="calculate">=</button>
    </div>
</div>

<script>
    // --- 状态与核心变量 ---
    let currentState = 0; // 0:初始待命, 1:首次等号记录, 2:差值隐藏逐位显示, 3:差值显示完毕, 4:完全正常, 99:锁定(彩蛋)
    let R = null; // 记录的结果
    let N = null; // 生成的数字
    let D = null; // 差值
    let D_str = ""; // 差值字符串形式
    let P = 0; // 逐位显示指针

    // --- 计算器常规变量 ---
    let currentInput = "0";
    let previousInput = null;
    let currentOperator = null;
    let waitingForNewValue = false;

    const displayEl = document.getElementById('display');
    const acBtn = document.getElementById('btn-ac');

    // --- 工具函数 ---
    function updateDisplay(val) {
        displayEl.innerText = val !== undefined ? val : currentInput;
        // 动态调整字体大小防止溢出
        if (displayEl.innerText.length > 7) {
            displayEl.style.fontSize = Math.max(30, 80 - (displayEl.innerText.length - 7) * 6) + 'px';
        } else {
            displayEl.style.fontSize = '80px';
        }
    }

    function formatNumber(num) {
        return parseFloat(num.toFixed(10)).toString(); // 简单处理浮点数精度
    }

    function calculateResult() {
        if (previousInput === null || currentOperator === null) return currentInput;
        const prev = parseFloat(previousInput);
        const curr = parseFloat(currentInput);
        let res = 0;
        switch (currentOperator) {
            case '+': res = prev + curr; break;
            case '-': res = prev - curr; break;
            case '×': res = prev * curr; break;
            case '÷': res = curr === 0 ? "错误" : prev / curr; break;
        }
        return res === "错误" ? res : formatNumber(res);
    }

    // --- 时间生成规则 (7/8位数) ---
    function generateMagicNumber() {
        const now = new Date();
        const M = (now.getMonth() + 1).toString(); // 月份 1-12
        const DD = now.getDate().toString().padStart(2, '0'); // 日期 01-31
        const HH = now.getHours().toString().padStart(2, '0'); // 小时 00-23
        const mm = now.getMinutes().toString().padStart(2, '0'); // 分钟 00-59
        
        const timeStr = M + DD + HH + mm;
        return parseInt(timeStr, 10);
    }

    // --- 全局点击事件拦截（处理状态 2 和 3 的特殊逻辑） ---
    // 使用捕获阶段 (true) 来在按钮触发之前拦截点击
    document.addEventListener('click', function(e) {
        if (currentState === 99) {
            // 彩蛋锁定状态，屏蔽所有操作
            e.stopPropagation();
            e.preventDefault();
            return;
        }

        const isAcBtn = e.target.closest('#btn-ac');

        if (currentState === 1 && !isAcBtn) {
            // 状态1：若变量 R 存在，点击任意位置（除清屏外）没有任何变化。
            e.stopPropagation();
            e.preventDefault();
            return;
        }

        if (currentState === 2) {
            // 状态2：点击任意位置逐位显示
            e.stopPropagation();
            e.preventDefault();
            
            if (P < D_str.length) {
                const currentDisplay = (P === 0) ? "" : displayEl.innerText;
                updateDisplay(currentDisplay + D_str[P]);
                P++;
            }
            if (P === D_str.length) {
                currentState = 3; // 流转到状态3
            }
            return;
        }

        if (currentState === 3) {
            // 状态3：显示完毕状态
            if (!isAcBtn) {
                // 点击非清屏区域无反应
                e.stopPropagation();
                e.preventDefault();
            }
            return;
        }

    }, true);


    // --- 按钮事件分发 ---
    document.querySelector('.buttons').addEventListener('click', (e) => {
        const btn = e.target.closest('.btn');
        if (!btn) return;

        // 如果在状态2，这里的事件由于全局捕获阶段被拦截，不会执行到这里
        // 如果在状态3且不是AC，也会被拦截

        const action = btn.dataset.action;
        const val = btn.dataset.val;

        // 处理清屏键 (AC/C)
        if (btn.id === 'btn-ac') {
            handleAC();
            return;
        }

        // 常规计算器操作
        if (action === 'number') handleNumber(val);
        if (action === 'operator') handleOperator(val);
        if (action === 'calculate') handleEqual();
        if (action === 'toggle-sign') handleToggleSign();
        if (action === 'percent') handlePercent();
    });

    // --- 核心逻辑处理函数 ---

    function handleAC() {
        if (currentState === 1) {
            // 状态1 流转到 状态2
            updateDisplay("0"); // 清屏显示 0
            
            N = generateMagicNumber();
            D = Math.abs(N - parseFloat(R));
            
            if (D === 0) {
                // 彩蛋触发
                updateDisplay(R.toString());
                displayEl.classList.add('success');
                currentState = 99; // 完全锁定
            } else {
                D_str = D.toString();
                P = 0;
                currentState = 2;
            }
            
            // 重置计算器底层逻辑状态
            currentInput = "0";
            previousInput = null;
            currentOperator = null;
            acBtn.innerText = "AC";
            return;
        }

        if (currentState === 3) {
            // 状态3 流转到 状态4
            currentState = 4;
            updateDisplay("0");
            currentInput = "0";
            previousInput = null;
            currentOperator = null;
            acBtn.innerText = "AC";
            return;
        }

        // 常规清屏逻辑 (状态 0 和 4)
        currentInput = "0";
        previousInput = null;
        currentOperator = null;
        waitingForNewValue = false;
        acBtn.innerText = "AC";
        updateDisplay();
    }

    function handleEqual() {
        if (currentState === 0) {
            // 状态0按下等号
            if (previousInput !== null && currentOperator !== null) {
                currentInput = calculateResult();
                previousInput = null;
                currentOperator = null;
            }
            R = parseFloat(currentInput); // 无论是否输入运算式，都记录结果为R
            currentState = 1; // 流转到状态1
            waitingForNewValue = true;
            updateDisplay();
            return;
        }

        if (currentState === 4) {
            // 状态4正常计算
            if (previousInput !== null && currentOperator !== null) {
                currentInput = calculateResult();
                previousInput = null;
                currentOperator = null;
                waitingForNewValue = true;
                updateDisplay();
            }
        }
    }

    function handleNumber(num) {
        if (waitingForNewValue) {
            currentInput = num;
            waitingForNewValue = false;
        } else {
            if (currentInput === "0" && num !== ".") {
                currentInput = num;
            } else {
                if (num === "." && currentInput.includes(".")) return;
                currentInput += num;
            }
        }
        acBtn.innerText = "C";
        updateDisplay();
    }

    function handleOperator(op) {
        if (previousInput !== null && !waitingForNewValue && currentOperator !== null) {
            currentInput = calculateResult();
            updateDisplay();
        }
        previousInput = currentInput;
        currentOperator = op;
        waitingForNewValue = true;
    }

    function handleToggleSign() {
        if (currentInput !== "0" && currentInput !== "错误") {
            currentInput = (parseFloat(currentInput) * -1).toString();
            updateDisplay();
        }
    }

    function handlePercent() {
        if (currentInput !== "错误") {
            currentInput = (parseFloat(currentInput) / 100).toString();
            updateDisplay();
        }
    }

</script>
</body>
</html>